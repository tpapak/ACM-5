---
title: "study191"
author: "Theodoros Papakonstantinou"
date: "2024-02-14"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(netmeta)
library(readxl)
source("studygraph.R")
```

```{r readData, echo=F}
ACM_5_with_networks <- read_excel("data/ACM-5%-studyid-networks-study191.xlsx")

#Insert variance
studyTable <- ACM_5_with_networks %>% 
  filter(!is.na(effect)) %>% 
  mutate(var = se^2) %>% 
  filter(id=="191" | id=="191_a")
```

```{r studies ,echo=F}
studyIds <- unique(studyTable$id)
```

I will check several ways of dealing with study 191.
The first thing is to duplicate the first three rows and change the id

```{r studyReport, echo=T}
studyIds <- unique(studyTable$id)
errorstudies <- c()
warnmess <- c()
studyInconsistency <- data.frame()
studyGraphs <- lapply(studyIds, function(stid){
  res <- {}
  tryCatch({
    stgr <- fullGraph(stid, studyTable ,rand=F)
    res <- stgr
  },error = function(cond){
    # print(c("error in study",stid))
    errorstudies <<- c(errorstudies,stid)
    # message(conditionMessage(cond))
  })
  return(res)
})
SGs <- Filter(function(g){!is.null(g)},studyGraphs)
lapply(SGs, function(g){plotEffects(g)})
```

From '191' and '191_a' we can have 2 versions of network 7 (net 7 and net 8)
Network 7 uses the prepooled PRO vs low CHO, while network 8 pools AP and PP vs SFA 

```{r Analysis}
lapply(7:8,function(netid){
  print(paste("Network ", netid, sep=""))
  studyRows <- Reduce(function(acc, sg){
    tryCatch({
      ns <- prepareStudyForNetwork(sg,netid,studyTable)
      nsr <- rowsFromGraph(ns)
      acc <- rbind(nsr,acc)
    },error = function(cond){
    })
    return(acc)
    },SGs,data.frame())
  print(studyRows)
  net1 <- netmeta(TE=TE,seTE=seTE,treat1=treat1,treat2=treat2,studlab=studlab
                 ,data=studyRows
                 ,reference.group="low quality CHO / Mono-/ Disaccharides")
  netgraph(net1)
  forest(net1,pooled="fixed")
  # print(paste("tau: ",net1$tau, sep=""))
  # Pscores=netrank(net1, small.values = "good")
  # Pscores
})
```
We see substantial difference since the prepooled gives a much lower effect for  PRO.
So I suggest we keep the definition of network 7 as is for study 191